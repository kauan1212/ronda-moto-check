
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://wncyfbkhgwcpbpbtbwaq.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduY3lmYmtoZ3djcGJwYnRid2FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MDQxMjEsImV4cCI6MjA2NjQ4MDEyMX0.QyYLjCWR6Y5xXVP9i7O1wOFNLL2gYYhB6vWr-pFh4Gs";

// ConfiguraÃ§Ã£o personalizada para persistÃªncia de sessÃ£o
const localStorageKey = 'supabase.auth.token';

// FunÃ§Ã£o para obter o token armazenado localmente
const getStoredSession = () => {
  if (typeof window === 'undefined') return null;
  const storedData = localStorage.getItem(localStorageKey);
  if (!storedData) return null;
  
  try {
    const parsed = JSON.parse(storedData);
    return parsed.currentSession;
  } catch (error) {
    console.error('Erro ao analisar sessÃ£o armazenada:', error);
    return null;
  }
};

// ConfiguraÃ§Ã£o do cliente Supabase com opÃ§Ãµes personalizadas
export const supabase = createClient<Database>(
  SUPABASE_URL, 
  SUPABASE_PUBLISHABLE_KEY,
  {
    auth: {
      storageKey: 'vigio-auth-token',
      autoRefreshToken: true,
      persistSession: true,
      detectSessionInUrl: true,
      storage: {
        getItem: (key) => {
          const item = localStorage.getItem(key);
          console.log('ğŸ”‘ Obtendo item do armazenamento:', key, item ? '***' : 'nÃ£o encontrado');
          return item;
        },
        setItem: (key, value) => {
          console.log('ğŸ’¾ Definindo item no armazenamento:', key, value ? '***' : 'vazio');
          localStorage.setItem(key, value);
        },
        removeItem: (key) => {
          console.log('ğŸ—‘ï¸ Removendo item do armazenamento:', key);
          localStorage.removeItem(key);
        },
      },
    },
  }
);

// Adiciona logs para eventos de autenticaÃ§Ã£o
supabase.auth.onAuthStateChange((event, session) => {
  console.log('ğŸ” Evento de autenticaÃ§Ã£o:', event, session ? 'SessÃ£o ativa' : 'Sem sessÃ£o');
  
  if (event === 'SIGNED_IN') {
    console.log('âœ… UsuÃ¡rio autenticado:', session?.user?.email);
  } else if (event === 'SIGNED_OUT') {
    console.log('ğŸšª UsuÃ¡rio desconectado');
  } else if (event === 'TOKEN_REFRESHED') {
    console.log('ğŸ”„ Token atualizado');
  } else if (event === 'USER_UPDATED') {
    console.log('ğŸ‘¤ Dados do usuÃ¡rio atualizados');
  }
});

// Verifica a sessÃ£o atual ao carregar
const checkCurrentSession = async () => {
  try {
    const { data, error } = await supabase.auth.getSession();
    if (error) {
      console.error('âŒ Erro ao verificar sessÃ£o:', error);
      return;
    }
    
    if (data.session) {
      console.log('ğŸ” SessÃ£o encontrada:', {
        user: data.session.user.email,
        expiresAt: new Date(data.session.expires_at * 1000).toISOString(),
        expiresIn: Math.round((data.session.expires_at * 1000 - Date.now()) / 1000 / 60) + ' minutos'
      });
    } else {
      console.log('ğŸ” Nenhuma sessÃ£o ativa encontrada');
    }
  } catch (error) {
    console.error('âŒ Erro inesperado ao verificar sessÃ£o:', error);
  }
};

// Executa a verificaÃ§Ã£o de sessÃ£o quando o cliente for importado
if (typeof window !== 'undefined') {
  console.log('ğŸ” Verificando sessÃ£o atual...');
  checkCurrentSession();
}
